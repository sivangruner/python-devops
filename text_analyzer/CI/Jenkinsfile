pipeline {
    agent any

    environment {
        GIT_TAG_VALUE = ''
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    // Detect if build is triggered by a tag
                    def tagName = sh(script: "git describe --tags --exact-match || echo ''", returnStdout: true).trim()

                    if (tagName) {
                        env.GIT_TAG_VALUE = tagName
                        echo "Checking out tag ${tagName}"
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: tagName]],
                            doGenerateSubmoduleConfigurations: false,
                            extensions: [],
                            userRemoteConfigs: [[url: 'https://github.com/sivangruner/python-devops.git']]
                        ])
                    } else {
                        // normal branch checkout
                        checkout scm
                    }
                }
            }
        }

        stage('Lint') {
            steps {
                echo "Running lint..."
                // your lint steps
            }
        }

        stage('Build') {
            when { expression { env.GIT_TAG_VALUE } } // runs only if tag build
            steps {
                echo "Building release for tag ${env.GIT_TAG_VALUE}"
            }
        }

        stage('Test') {
            steps {
                echo "Running tests..."
            }
        }

        stage('Deploy') {
            when { expression { env.GIT_TAG_VALUE } } // only on tags
            steps {
                echo "Deploying ${env.GIT_TAG_VALUE}"
            }
        }
    }
}
